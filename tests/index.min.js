"use strict";var LayerInfoService={URL:"../build/layer_info.json",codePointsArr:null,map:null,_initPromise:null,init:function(){var t=new Promise(function(t){var n=new XMLHttpRequest;n.open("GET",this.URL,!0),n.responseType="json",n.send(),n.onloadend=function(){t(n.response)}}.bind(this)).then(function(t){if(this.codePointsArr=[],this.map=new Map,!t)throw new Error("LayerInfoService: Failed to load glyph layer information.");for(var n in t){var e=n.split(/[\-_]/).map(function(t){return parseInt(t,16)}),i=e.map(function(t){for(var n=t.toString(16).toUpperCase();n.length<4;)n="0"+n;return"U+"+n}).join(" ");this.map.set(i,{layers:t[n].length,fileNames:t[n]}),this.codePointsArr.push(e)}}.bind(this));return this._initPromise=t,t},getCodePointsArr:function(){var t=Promise.resolve();return this.codePointsArr||(t=this.init()),t.then(function(){return this.codePointsArr}.bind(this))},getInfo:function(t){var n=Promise.resolve();return this.map||(n=this.init()),n.then(function(){var n=t.map(function(t){for(var n=t.toString(16).toUpperCase();n.length<4;)n="0"+n;return"U+"+n}).join(" ");return this.map.get(n)}.bind(this))}},ComparisonTest=function(t){this.codePoints=t,this.string=this.codePointsToString(t),this.retested=!1};ComparisonTest.prototype={FONT_NAME:"Twemoji Mozilla",CANVAS_SIZE:480,SVG_SIZE:64,RETEST_THRESHOLD:1,RETEST_UPPER_THRESHOLD:4,RETEST_CANVAS_SIZE:960,run:function(){return Promise.all([this.runCanvases().then(this.runSVGImageCompare.bind(this)).then(this.runCanvasesCompare.bind(this)),this.runGetLayerInfo()]).then(function(){return this}.bind(this))},runCanvases:function(){return Promise.all([this.getSystemRenderingCanvas(),this.getEmojiRenderingCanvas(),this.getSVGRenderingCanvas()]).then(function(t){this.systemRenderingCanvas=t[0],this.emojiRenderingCanvas=t[1],this.svgRenderingCanvas=t[2]}.bind(this))},runSVGImageCompare:function(){return this.imageCompare(this.svgRenderingCanvas,this.emojiRenderingCanvas).then(function(t){var n=t.rawMisMatchPercentage;return n>this.RETEST_THRESHOLD&&n<this.RETEST_UPPER_THRESHOLD?(this.retested=!0,Promise.all([this.getSystemRenderingCanvas(this.RETEST_CANVAS_SIZE),this.getEmojiRenderingCanvas(this.RETEST_CANVAS_SIZE),this.getSVGRenderingCanvas(this.RETEST_CANVAS_SIZE)]).then(function(t){this.systemRenderingCanvas=t[0],this.emojiRenderingCanvas=t[1],this.svgRenderingCanvas=t[2]}.bind(this)).then(function(){return this.imageCompare(this.svgRenderingCanvas,this.emojiRenderingCanvas)}.bind(this))):t}.bind(this)).then(function(t){this.diffData=t}.bind(this))},runCanvasesCompare:function(){this.isEqualToSystem=this.canvasEqual(this.systemRenderingCanvas,this.emojiRenderingCanvas),this.emojiRenderingEmpty=this.canvasEmpty(this.emojiRenderingCanvas),this.svgRenderingEmpty=this.canvasEmpty(this.svgRenderingCanvas)},runGetLayerInfo:function(){return LayerInfoService.getInfo(this.codePoints).then(function(t){this.layerInfo=t}.bind(this))},codePointsToString:function(t){var n=String.fromCodePoint.apply(String,t);return 1===t.length&&t[0]<65535&&(n+="️"),n},getEmptyCanvas:function(t){t=t||this.CANVAS_SIZE;var n=document.createElement("canvas",{willReadFrequently:!0});return n.width=t,n.height=t,n},getTextCanvasWithFont:function(t,n){n=n||this.CANVAS_SIZE;var e=this.getEmptyCanvas(n),i=e.getContext("2d");return i.font=n+"px "+t,i.textBaseline="bottom",i.textAlign="center",i.fillText(this.string,n/2,n),e},getSystemRenderingCanvas:function(t){return this.getTextCanvasWithFont(void 0,t)},getEmojiRenderingCanvas:function(t){return this.getTextCanvasWithFont(this.FONT_NAME,t)},getSVGRawImg:function(){if(this.svgRawImgPromise)return this.svgRawImgPromise;var t=void 0,n=void 0,e=this.svgUrl="../build/colorGlyphs/u"+this.codePoints.filter(function(e){return e==t&&t==n&&8205==e?(n=t,t=e,e):(n=t,t=e,8205!==e)}).map(function(t){return t.toString(16)}).join("-")+".svg",i=new DOMParser;return this.svgRawImgPromise=new Promise(function(t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="text",n.send(),n.onloadend=function(){t(n.response)}}).then(function(t){if("<svg "===t.substr(0,5)){var n=i.parseFromString(t,"image/svg+xml");return!!n.rootElement.getAttribute("width")||(n.rootElement.setAttribute("width",this.SVG_SIZE),n.rootElement.setAttribute("height",this.SVG_SIZE),t=n.rootElement.outerHTML),"data:image/svg+xml,"+encodeURIComponent(t)}}.bind(this)).then(function(t){if(t)return this.svgDataUrl=t,new Promise(function(n){var e=new Image;e.src=t,e.onload=function(){n(e)}}.bind(this))}.bind(this))},getSVGRenderingCanvas:function(t){return t=t||this.CANVAS_SIZE,this.getSVGRawImg().then(function(n){var e=this.getEmptyCanvas(t);n&&e.getContext("2d").drawImage(n,0,0,this.SVG_SIZE,this.SVG_SIZE,0,0,t,t);return e}.bind(this))},canvasEqual:function(t,n){for(var e=this.getImageDataArray(t),i=this.getImageDataArray(n),r=0;r<e.length;r++)if(e[r]!==i[r])return!1;return!0},imageCompare:function(t,n){return Promise.all([new Promise(function(n){t.toBlob(n)}),new Promise(function(t){n.toBlob(t)})]).then(function(t){return new Promise(function(n){resemble(t[0]).compareTo(t[1]).ignoreAntialiasing().onComplete(n)})})},canvasEmpty:function(t){for(var n=this.getImageDataArray(t),e=0;e<n.length;e++)if(n[e])return!1;return!0},getImageDataArray:function(t){return t.getContext("2d").getImageData(0,0,t.width,t.height).data}};var TestLoader=function(){};function start(t){"string"==typeof t&&(t=t.split(",").map(function(t){return t.split(" ").map(function(t){return t.trim()}).filter(function(t){return""!==t}).map(function(t){return"U+"===t.substr(0,2)&&(t=t.substr(2)),parseInt(t,16)})})),(new TestLoader).run(t).catch(function(t){alert(t.toString()+"\n\n"+t.stack),console.error(t)})}function changeHashAndStart(t){t===decodeURIComponent(document.location.hash.substr(1))?start(t):document.location.hash="#"+t}TestLoader.prototype={run:function(t){return this.testRunReport=new TestRunReport,document.body.appendChild(this.testRunReport.render()),(t?Promise.resolve(t):LayerInfoService.getCodePointsArr()).then(function(t){var n=Promise.resolve();return t.forEach(function(t,e){n=n.then(function(){return new ComparisonTest(t).run().then(this.testRunReport.appendResult.bind(this.testRunReport))}.bind(this))}.bind(this)),n}.bind(this)).then(function(){this.testRunReport.reportFinish()}.bind(this),function(t){throw this.testRunReport.reportFinish(),t}.bind(this))}},document.location.hash&&(document.getElementById("codepoints").value=decodeURIComponent(document.location.hash.substr(1))),window.addEventListener("hashchange",function(){var t=decodeURIComponent(document.location.hash.substr(1));t&&start(t)}),document.body.classList.toggle("hide-passed",document.getElementById("hide-passed").checked);
