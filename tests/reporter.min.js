'use strict';var EmojiInfoService={URL:'../node_modules/emoji-table/dist/emoji.json',map:null,_initPromise:null,init:function(){var c=new Promise(function(d){var f=new XMLHttpRequest;f.open('GET',this.URL,!0),f.responseType='json',f.send(),f.onloadend=function(){d(f.response)}}.bind(this)).then(function(d){if(this.map=new Map,!d)return void console.warn('EmojiInfoService: Failed to load table.');for(var f of d)this.map.set(f.code,f)}.bind(this));return this._initPromise=c,c},getInfo:function(c){var d=Promise.resolve();return this.map||(d=this.init()),d.then(function(){var f=c.map(function(k){for(var l=k.toString(16).toUpperCase();4>l.length;)l='0'+l;return'U+'+l}),g=c.length;do{var h=f.slice(0,g).join(' '),j=this.map.get(h);if(j)return j}while(--g);return null}.bind(this))}},TestRunReport=function(){this.summary=new TestSummary(this),this.startTime=Date.now(),this.expendedReports=0,this.resultSummaries=new Map};TestRunReport.prototype={AUTOEXPEND_REPORTS_LIMIT:0,render:function(){var c=this.element=document.createElement('div');return c.appendChild(this.summary.render()),c},appendResult:function(c){var d=this.expendedReports<this.AUTOEXPEND_REPORTS_LIMIT,f=new TestReport(c);this.element.appendChild(f.render(d)),f.expended&&this.expendedReports++;var g=f.getSummary();this.summary.update(g),this.resultSummaries.set(g,f.element),f.minimizeMemoryUsage()},reportFinish:function(){this.summary.reportFinish({time:Date.now()-this.startTime})},sortBy:function(c){var d=[...this.resultSummaries.keys()];d.sort(function(f,g){switch(c){case'mismatch':return g.mismatchPresentage-f.mismatchPresentage;break;default:if(f[c]===g[c])return 0;if(f[c])return-1;if(g[c])return 1;}}).forEach(function(f){var g=this.resultSummaries.get(f);this.element.appendChild(g)}.bind(this))}};var TestSummary=function(c){this.runReport=c,this.summary={},this.PROPS.forEach(function(d){this.summary[d]=0}.bind(this)),this.elements=new Map};TestSummary.prototype={PROPS:Object.freeze(['total','passed','failed','mismatch','webfont','rendering','reference','retested']),render:function(){return this.element=document.createElement('p'),this.element.className='summary',this.PROPS.forEach(function(c,d){0!==d&&this.element.appendChild(document.createTextNode(' '));var f=document.createElement('button');f.title='Click to re-sort by this property.',f.textContent=c+': ',f.dataset.sortByProp=c;var g=document.createElement('span');this.elements.set(c,g),f.appendChild(g),this.element.appendChild(f)}.bind(this)),this.element.addEventListener('click',this),this.element},handleEvent:function(c){var d=c.target.dataset.sortByProp;d&&(c.preventDefault(),this.runReport.sortBy(d))},update:function(c){this.summary.total++,this.PROPS.forEach(function(d){c[d]&&this.summary[d]++,this.elements.get(d).textContent=this.summary[d]}.bind(this))},reportFinish:function(c){this.element.appendChild(document.createTextNode(' Time: '+c.time+'ms'))}};var TestReport=function(c){this.result=c,this.expended=!1,this.detailRendered=!1,this.passed=c.diffData.rawMisMatchPercentage<this.MISMATCH_THRESHOLD&&!c.isEqualToSystem&&!c.emojiRenderingEmpty&&!c.svgRenderingEmpty};TestReport.prototype={MISMATCH_THRESHOLD:1,MINIMAL_REPORT:!1,render:function(c){var d=this.result,f=this.element=document.createElement('p'),g=document.createElement('span');g.className='title',g.appendChild(document.createTextNode(d.codePoints.map(function(k){for(var l=k.toString(16);4>l.length;)l='0'+l;return'U+'+l}).join(' ')+', '));var h=document.createElement('span');h.className='emoji',h.textContent=d.string,g.appendChild(h),g.appendChild(document.createTextNode(', reference: '+!d.svgRenderingEmpty+', rendering: '+!d.emojiRenderingEmpty+', webfont: '+!d.isEqualToSystem+', mismatch: '+d.diffData.rawMisMatchPercentage.toFixed(2)+'%, retested: '+d.retested+', layers: '+d.layerInfo.layers)),f.appendChild(g);var j=document.createElement('span');return j.className='emoji-info',EmojiInfoService.getInfo(d.codePoints).then(function(k){return k?void(j.textContent=k.name+'. tags: '+k.tags.join(', ')+'.'):void j.parentNode.removeChild(j)}).catch(function(k){console.error(k)}),f.appendChild(j),this.passed?f.classList.add('passed'):f.classList.add('failed'),this.MINIMAL_REPORT||(g.addEventListener('click',this),g.classList.add('clickable'),j.addEventListener('click',this),j.classList.add('clickable'),!this.passed&&c&&(this.element.classList.add('expended'),this.expended=!0,this.appendDetailReportDOM())),f},minimizeMemoryUsage:function(){this.MINIMAL_REPORT&&(this.result=null)},handleEvent:function(c){return'inspect-layers'===c.target.dataset.action?(c.target.parentNode.removeChild(c.target),void this.appendLayerReportDOM()):void(!this.detailRendered&&this.appendDetailReportDOM(),this.expended?(this.element.classList.remove('expended'),this.expended=!1):(this.element.classList.add('expended'),this.expended=!0))},getSummary:function(){var c=this.result;return{passed:this.passed,failed:!this.passed,mismatch:c.diffData.rawMisMatchPercentage>=this.MISMATCH_THRESHOLD,mismatchPresentage:c.diffData.rawMisMatchPercentage,webfont:c.isEqualToSystem,rendering:c.emojiRenderingEmpty,reference:c.svgRenderingEmpty,retested:c.retested}},appendDetailReportDOM:function(){this.detailRendered=!0;var c=document.createElement('span');c.className='detail';var d=this.result,f=document.createElement('span');f.className='dom-ref',f.textContent=d.string,f.title='Twemoji HTML rendering.',c.appendChild(f),c.appendChild(d.svgRenderingCanvas),d.svgRenderingCanvas.title='Source SVG rendering on canvas.',d.svgRenderingEmpty&&(d.svgRenderingCanvas.className='report-failed'),c.appendChild(d.emojiRenderingCanvas),d.emojiRenderingCanvas.title='Twemoji font rendering on canvas.',d.emojiRenderingEmpty&&(d.emojiRenderingCanvas.className='report-failed'),c.appendChild(d.systemRenderingCanvas),d.systemRenderingCanvas.title='System font rendering on canvas.',d.isEqualToSystem&&(d.systemRenderingCanvas.className='report-failed');var g=new Image;g.src=d.diffData.getImageDataUrl(),c.appendChild(g),g.title='Diff between source SVG and font rendering on canvas.',d.diffData.rawMisMatchPercentage>=this.MISMATCH_THRESHOLD&&(g.className='report-failed');var h=document.createElement('button');h.dataset.action='inspect-layers',h.textContent='Inspect layers',h.type='button',h.addEventListener('click',this),c.appendChild(h),this.element.appendChild(c)},appendLayerReportDOM:function(){var c=document.createElement('span');c.className='detail',this.result.layerInfo.fileNames.forEach(function(g){var h='../build/glyphs/'+g+'.svg',j=document.createElement('a');j.target='_blank',j.href=h,j.title='layer: '+g+'.svg';var k=new Image;k.src=h,k.className='layer',j.appendChild(k),c.appendChild(j)});var d=document.createElement('a');d.target='_blank',d.href=this.result.svgUrl,d.title='color svg';var f=new Image;f.src=this.result.svgUrl,f.className='layer',d.appendChild(f),c.appendChild(d),this.element.appendChild(c)}};
